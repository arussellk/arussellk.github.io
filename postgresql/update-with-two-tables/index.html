<!doctype html><html lang=en><head><meta charset=utf-8><title>Update with two tables</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=/images/favicon-32.png sizes=32x32><link rel=apple-touch-icon href=/images/favicon-180.png sizes=180x180><link rel=stylesheet href=/css/main.css></head><body><div class=main><p><a href=/>home</a></p><h1>Update With Two Tables</h1><p>Sometimes it is useful to update one table based on associated data found in a second table.
It is easy to accidentally affect all rows because the update syntax does not have the
<code>JOIN ... USING (some_id)</code> phrase that you would usually use to restrict rows by id.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#57606a>-- Often not what you intend!
</span></span></span><span style=display:flex><span><span style=color:#57606a>-- Affects all rows because the where clause evaluates to true.
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>update</span><span style=color:#fff> </span>foo<span style=color:#fff> </span>f<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>set</span><span style=color:#fff> </span>is_active<span style=color:#fff> </span><span style=color:#0550ae>=</span><span style=color:#fff> </span><span style=color:#cf222e>false</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>from</span><span style=color:#fff> </span>bar<span style=color:#fff> </span>b<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>where</span><span style=color:#fff> </span>b<span style=color:#1f2328>.</span>val<span style=color:#fff> </span><span style=color:#0550ae>=</span><span style=color:#fff> </span><span style=color:#0a3069>&#39;target&#39;</span><span style=color:#1f2328>;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#57606a>-- Affects rows when both where conditions evaluate to true,
</span></span></span><span style=display:flex><span><span style=color:#57606a>-- which is only the foo associated with &#39;target&#39; in this db.
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>update</span><span style=color:#fff> </span>foo<span style=color:#fff> </span>f<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>set</span><span style=color:#fff> </span>is_active<span style=color:#fff> </span><span style=color:#0550ae>=</span><span style=color:#fff> </span><span style=color:#cf222e>false</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>from</span><span style=color:#fff> </span>bar<span style=color:#fff> </span>b<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>where</span><span style=color:#fff> </span>b<span style=color:#1f2328>.</span>foo_id<span style=color:#fff> </span><span style=color:#0550ae>=</span><span style=color:#fff> </span>f<span style=color:#1f2328>.</span>foo_id<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>and</span><span style=color:#fff> </span>b<span style=color:#1f2328>.</span>val<span style=color:#fff> </span><span style=color:#0550ae>=</span><span style=color:#fff> </span><span style=color:#0a3069>&#39;target&#39;</span><span style=color:#1f2328>;</span><span style=color:#fff>
</span></span></span></code></pre></div><p>Full example:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#cf222e>create</span><span style=color:#fff> </span><span style=color:#cf222e>table</span><span style=color:#fff> </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#cf222e>not</span><span style=color:#fff> </span><span style=color:#cf222e>exists</span><span style=color:#fff> </span>foo<span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span>foo_id<span style=color:#fff> </span><span style=color:#6639ba>serial</span><span style=color:#fff> </span><span style=color:#cf222e>primary</span><span style=color:#fff> </span><span style=color:#cf222e>key</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span>username<span style=color:#fff> </span><span style=color:#6639ba>varchar</span><span style=color:#1f2328>(</span><span style=color:#0550ae>50</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#cf222e>unique</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span>is_active<span style=color:#fff> </span><span style=color:#6639ba>boolean</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>);</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>create</span><span style=color:#fff> </span><span style=color:#cf222e>table</span><span style=color:#fff> </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#cf222e>not</span><span style=color:#fff> </span><span style=color:#cf222e>exists</span><span style=color:#fff> </span>bar<span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span>bar_id<span style=color:#fff> </span><span style=color:#6639ba>serial</span><span style=color:#fff> </span><span style=color:#cf222e>primary</span><span style=color:#fff> </span><span style=color:#cf222e>key</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span>foo_id<span style=color:#fff> </span><span style=color:#6639ba>integer</span><span style=color:#fff> </span><span style=color:#cf222e>references</span><span style=color:#fff> </span>foo<span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span>val<span style=color:#fff> </span><span style=color:#6639ba>varchar</span><span style=color:#1f2328>(</span><span style=color:#0550ae>50</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>);</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>insert</span><span style=color:#fff> </span><span style=color:#cf222e>into</span><span style=color:#fff> </span>foo<span style=color:#fff> </span><span style=color:#1f2328>(</span>username<span style=color:#1f2328>,</span><span style=color:#fff> </span>is_active<span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>values</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#39;first&#39;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#cf222e>true</span><span style=color:#1f2328>),</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#39;second&#39;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#cf222e>true</span><span style=color:#1f2328>),</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#39;third&#39;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#cf222e>true</span><span style=color:#1f2328>);</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>insert</span><span style=color:#fff> </span><span style=color:#cf222e>into</span><span style=color:#fff> </span>bar<span style=color:#fff> </span><span style=color:#1f2328>(</span>foo_id<span style=color:#1f2328>,</span><span style=color:#fff> </span>val<span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>values</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>(</span><span style=color:#0550ae>1</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0a3069>&#39;target&#39;</span><span style=color:#1f2328>),</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>(</span><span style=color:#0550ae>2</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0a3069>&#39;not the target&#39;</span><span style=color:#1f2328>),</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>(</span><span style=color:#0550ae>3</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0a3069>&#39;not the target&#39;</span><span style=color:#1f2328>);</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>select</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>from</span><span style=color:#fff> </span>foo<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>join</span><span style=color:#fff> </span>bar<span style=color:#fff> </span><span style=color:#cf222e>using</span><span style=color:#fff> </span><span style=color:#1f2328>(</span>foo_id<span style=color:#1f2328>);</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#57606a>-- Affects no rows because the where clause evaluates to false.
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>update</span><span style=color:#fff> </span>foo<span style=color:#fff> </span>f<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>set</span><span style=color:#fff> </span>is_active<span style=color:#fff> </span><span style=color:#0550ae>=</span><span style=color:#fff> </span><span style=color:#cf222e>false</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>from</span><span style=color:#fff> </span>bar<span style=color:#fff> </span>b<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>where</span><span style=color:#fff> </span>b<span style=color:#1f2328>.</span>val<span style=color:#fff> </span><span style=color:#0550ae>=</span><span style=color:#fff> </span><span style=color:#0a3069>&#39;not in the db&#39;</span><span style=color:#1f2328>;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#57606a>-- Often not what you intend!
</span></span></span><span style=display:flex><span><span style=color:#57606a>-- Affects all rows because the where clause evaluates to true.
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>update</span><span style=color:#fff> </span>foo<span style=color:#fff> </span>f<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>set</span><span style=color:#fff> </span>is_active<span style=color:#fff> </span><span style=color:#0550ae>=</span><span style=color:#fff> </span><span style=color:#cf222e>false</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>from</span><span style=color:#fff> </span>bar<span style=color:#fff> </span>b<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>where</span><span style=color:#fff> </span>b<span style=color:#1f2328>.</span>val<span style=color:#fff> </span><span style=color:#0550ae>=</span><span style=color:#fff> </span><span style=color:#0a3069>&#39;target&#39;</span><span style=color:#1f2328>;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#57606a>-- Affects rows when both where conditions evaluate to true,
</span></span></span><span style=display:flex><span><span style=color:#57606a>-- which is only the foo associated with &#39;target&#39; in this db.
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>update</span><span style=color:#fff> </span>foo<span style=color:#fff> </span>f<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>set</span><span style=color:#fff> </span>is_active<span style=color:#fff> </span><span style=color:#0550ae>=</span><span style=color:#fff> </span><span style=color:#cf222e>false</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>from</span><span style=color:#fff> </span>bar<span style=color:#fff> </span>b<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>where</span><span style=color:#fff> </span>b<span style=color:#1f2328>.</span>foo_id<span style=color:#fff> </span><span style=color:#0550ae>=</span><span style=color:#fff> </span>f<span style=color:#1f2328>.</span>foo_id<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>and</span><span style=color:#fff> </span>b<span style=color:#1f2328>.</span>val<span style=color:#fff> </span><span style=color:#0550ae>=</span><span style=color:#fff> </span><span style=color:#0a3069>&#39;target&#39;</span><span style=color:#1f2328>;</span><span style=color:#fff>
</span></span></span></code></pre></div></div></body></html>