<!doctype html><html lang=en><head><meta charset=utf-8><title>Update with two tables</title>
<meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=/images/favicon-32.png sizes=32x32><link rel=apple-touch-icon href=/images/favicon-180.png sizes=180x180><link rel=stylesheet href=/css/main.css></head><body><div class=main><p><a href=/>home</a></p><h1>Update With Two Tables</h1><p>Sometimes it is useful to update one table based on associated data found in a second table.
It is easy to accidentally affect all rows because the update syntax does not have the
<code>JOIN ... USING (some_id)</code> phrase that you would usually use to restrict rows by id.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#998;font-style:italic>-- Often not what you intend!
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>-- Affects all rows because the where clause evaluates to true.
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span><span style=color:#000;font-weight:700>update</span><span style=color:#bbb> </span>foo<span style=color:#bbb> </span>f<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>set</span><span style=color:#bbb> </span>is_active<span style=color:#bbb> </span><span style=color:#000;font-weight:700>=</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>false</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>from</span><span style=color:#bbb> </span>bar<span style=color:#bbb> </span>b<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>where</span><span style=color:#bbb> </span>b.val<span style=color:#bbb> </span><span style=color:#000;font-weight:700>=</span><span style=color:#bbb> </span><span style=color:#d14>&#39;target&#39;</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#998;font-style:italic>-- Affects rows when both where conditions evaluate to true,
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>-- which is only the foo associated with &#39;target&#39; in this db.
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span><span style=color:#000;font-weight:700>update</span><span style=color:#bbb> </span>foo<span style=color:#bbb> </span>f<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>set</span><span style=color:#bbb> </span>is_active<span style=color:#bbb> </span><span style=color:#000;font-weight:700>=</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>false</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>from</span><span style=color:#bbb> </span>bar<span style=color:#bbb> </span>b<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>where</span><span style=color:#bbb> </span>b.foo_id<span style=color:#bbb> </span><span style=color:#000;font-weight:700>=</span><span style=color:#bbb> </span>f.foo_id<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>and</span><span style=color:#bbb> </span>b.val<span style=color:#bbb> </span><span style=color:#000;font-weight:700>=</span><span style=color:#bbb> </span><span style=color:#d14>&#39;target&#39;</span>;<span style=color:#bbb>
</span></span></span></code></pre></div><p>Full example:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000;font-weight:700>create</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>table</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>if</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>not</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>exists</span><span style=color:#bbb> </span>foo<span style=color:#bbb> </span>(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>foo_id<span style=color:#bbb> </span><span style=color:#0086b3>serial</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>primary</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>key</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>username<span style=color:#bbb> </span><span style=color:#0086b3>varchar</span>(<span style=color:#099>50</span>)<span style=color:#bbb> </span><span style=color:#000;font-weight:700>unique</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>is_active<span style=color:#bbb> </span><span style=color:#0086b3>boolean</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>create</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>table</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>if</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>not</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>exists</span><span style=color:#bbb> </span>bar<span style=color:#bbb> </span>(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>bar_id<span style=color:#bbb> </span><span style=color:#0086b3>serial</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>primary</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>key</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>foo_id<span style=color:#bbb> </span><span style=color:#0086b3>integer</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>references</span><span style=color:#bbb> </span>foo,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>val<span style=color:#bbb> </span><span style=color:#0086b3>varchar</span>(<span style=color:#099>50</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>insert</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>into</span><span style=color:#bbb> </span>foo<span style=color:#bbb> </span>(username,<span style=color:#bbb> </span>is_active)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>values</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>(<span style=color:#d14>&#39;first&#39;</span>,<span style=color:#bbb> </span><span style=color:#000;font-weight:700>true</span>),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>(<span style=color:#d14>&#39;second&#39;</span>,<span style=color:#bbb> </span><span style=color:#000;font-weight:700>true</span>),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>(<span style=color:#d14>&#39;third&#39;</span>,<span style=color:#bbb> </span><span style=color:#000;font-weight:700>true</span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>insert</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>into</span><span style=color:#bbb> </span>bar<span style=color:#bbb> </span>(foo_id,<span style=color:#bbb> </span>val)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>values</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>(<span style=color:#099>1</span>,<span style=color:#bbb> </span><span style=color:#d14>&#39;target&#39;</span>),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>(<span style=color:#099>2</span>,<span style=color:#bbb> </span><span style=color:#d14>&#39;not the target&#39;</span>),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>(<span style=color:#099>3</span>,<span style=color:#bbb> </span><span style=color:#d14>&#39;not the target&#39;</span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>*</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>from</span><span style=color:#bbb> </span>foo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>join</span><span style=color:#bbb> </span>bar<span style=color:#bbb> </span><span style=color:#000;font-weight:700>using</span><span style=color:#bbb> </span>(foo_id);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#998;font-style:italic>-- Affects no rows because the where clause evaluates to false.
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span><span style=color:#000;font-weight:700>update</span><span style=color:#bbb> </span>foo<span style=color:#bbb> </span>f<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>set</span><span style=color:#bbb> </span>is_active<span style=color:#bbb> </span><span style=color:#000;font-weight:700>=</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>false</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>from</span><span style=color:#bbb> </span>bar<span style=color:#bbb> </span>b<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>where</span><span style=color:#bbb> </span>b.val<span style=color:#bbb> </span><span style=color:#000;font-weight:700>=</span><span style=color:#bbb> </span><span style=color:#d14>&#39;not in the db&#39;</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#998;font-style:italic>-- Often not what you intend!
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>-- Affects all rows because the where clause evaluates to true.
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span><span style=color:#000;font-weight:700>update</span><span style=color:#bbb> </span>foo<span style=color:#bbb> </span>f<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>set</span><span style=color:#bbb> </span>is_active<span style=color:#bbb> </span><span style=color:#000;font-weight:700>=</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>false</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>from</span><span style=color:#bbb> </span>bar<span style=color:#bbb> </span>b<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>where</span><span style=color:#bbb> </span>b.val<span style=color:#bbb> </span><span style=color:#000;font-weight:700>=</span><span style=color:#bbb> </span><span style=color:#d14>&#39;target&#39;</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#998;font-style:italic>-- Affects rows when both where conditions evaluate to true,
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>-- which is only the foo associated with &#39;target&#39; in this db.
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span><span style=color:#000;font-weight:700>update</span><span style=color:#bbb> </span>foo<span style=color:#bbb> </span>f<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>set</span><span style=color:#bbb> </span>is_active<span style=color:#bbb> </span><span style=color:#000;font-weight:700>=</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>false</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>from</span><span style=color:#bbb> </span>bar<span style=color:#bbb> </span>b<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>where</span><span style=color:#bbb> </span>b.foo_id<span style=color:#bbb> </span><span style=color:#000;font-weight:700>=</span><span style=color:#bbb> </span>f.foo_id<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>and</span><span style=color:#bbb> </span>b.val<span style=color:#bbb> </span><span style=color:#000;font-weight:700>=</span><span style=color:#bbb> </span><span style=color:#d14>&#39;target&#39;</span>;<span style=color:#bbb>
</span></span></span></code></pre></div></div></body></html>