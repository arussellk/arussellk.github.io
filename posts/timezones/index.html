<!doctype html><html lang=en><head><meta charset=utf-8><title>Time handling for purchase transactions</title><link rel=stylesheet href=/css/main.css></head><body><div class=main><h1>Time handling for purchase transactions</h1><p>Advice commonly found on the internet for how to program with timezones is some
version of:</p><ol><li>Only store UTC datetimes in your database. (e.g.,
<code>2022-01-08T10:45:00.000Z</code>.)</li><li>Convert the UTC datetime to the user&rsquo;s timezone for display. (e.g.,
<code>2022-01-08T10:45:00.000Z -> 2022-01-08T03:45:00-07:00</code>.)</li></ol><p>This advice is good for keeping track of a single point in time (e.g., when
does the meeting start), but sometimes working with timezones is slightly more
complicated.
The purpose of this post is to explain a situation that I encountered where it
took some extra effort to convert the UTC datetime from the database to the
appropriate timezone for display.</p><p>This post uses
<a href=https://en.wikipedia.org/wiki/ECMAScript>JavaScript</a>
and
<a href=https://momentjs.com/>Moment.js</a>
for code examples.
You can go to
<a href=https://momentjs.com/timezone/>Moment.js Timezone</a>
and open your developer console to execute and experiment with the code
yourself.
Dates shown in this post follow the
<a href=https://en.wikipedia.org/wiki/ISO_8601>ISO 8601 standard</a>.</p><h1 id=background>Background</h1><p>I worked on a system that showed users their bank account transaction
history. Users could grant access to their transaction history via OAuth,
allowing our system to read their transactions and display them in a nice way.
One day I received a bug report that the transaction date shown in our system
did not match the date the user expected. I looked at the code responsible for
getting the date from the bank&rsquo;s API and found that the previous author did not
consider timezones in their implementation. The existing code looked like this:</p><pre tabindex=0><code>// txn is loaded from the API
const txn = {
  utcDateTime: &#39;2022-04-30T23:01:00.000Z&#39;,
  // ...
};

const txnDate = txn.utcDateTime.slice(0, &#39;YYYY-MM-DD&#39;.length);
console.log(txnDate); // &#39;2022-04-30&#39;
</code></pre><p>The bug report said that this date should actually be <code>2022-05-01</code>.
I checked which bank API this transaction came from, and it was a bank located
in Great Britain (GB). The problem is that the existing code does not consider
timezones, and the solution is to interpret the transaction&rsquo;s <code>utcDateTime</code> in
the timezone that the transaction took place.</p><h1 id=what-went-wrong>What went wrong?</h1><p>Before we fix the problem, let&rsquo;s look at how this code worked well enough that
that previous author did not immediately notice the problem.
Most of the users of this system were located in the United States (US) and GB.
This means that as long as a transaction occurs <em>late</em> enough in the day in GB
such that representing it in UTC still appears in the same date, the simple
<code>.slice</code> works (i.e., after 1am local time while GB is using British Summer
Time).
On the other side of things, as long as a transaction occurs <em>early</em> enough in
the day in the US such that representing it in UTC still appears in the same
date, the simple <code>.slice</code> works (i.e., before 8pm or so local time on the East
Coast).
When a person sees a list of transactions and corresponding dates, they expect
to see the date they were experiencing when the payment occurred, not the date
of that instant represented in UTC, so it is necessary to interpret a
transaction&rsquo;s <code>utcDateTime</code> in the right timezone prior to display for a user.</p><p>Examples when <code>.slice</code> is correct and not correct:</p><table><thead><tr><th>Date</th><th>Date in UTC</th><th><code>.slice(utc)</code></th><th><code>.slice</code> correct?</th></tr></thead><tbody><tr><td>2022-04-30T12:34:56.789-04:00</td><td>2022-04-30T16:34:56.789Z</td><td>2022-04-30</td><td>yes</td></tr><tr><td>2022-04-30T20:34:56.789-04:00</td><td>2022-05-01T00:34:56.789Z</td><td>2022-05-01</td><td>no</td></tr><tr><td>2022-05-01T00:01:00.000+01:00</td><td>2022-04-30T23:01:00.000Z</td><td>2022-04-30</td><td>no</td></tr><tr><td>2022-05-01T01:01:00.000+01:00</td><td>2022-05-01T00:01:00.000Z</td><td>2022-05-01</td><td>yes</td></tr></tbody></table><h1 id=what-is-the-solution>What is the solution?</h1><p>I have shown that the first ten characters of a UTC datetime string does not
always match the transaction date a user expects to see.
To always interpret a transaction&rsquo;s utcDateTime in the correct zone, I need to
know in what timezone the transaction happened.
Fortunately, the bank API I was reading from included a country code for each
transaction, allowing me to fix the reported bug for the user in GB:</p><pre tabindex=0><code>// txn is loaded from the API
const txn = {
  utcDateTime: &#39;2022-04-30T23:01:00.000Z&#39;,
  country: &#39;GB&#39;,
  // ...
};

const zones = moment.tz.zonesForCountry(&#39;GB&#39;); // [&#39;Europe/London&#39;]
const zone = zones[0];

const txnDate = moment(txn.utcDateTime).tz(zone).format(&#39;YYYY-MM-DD&#39;);
console.log(txnDate); // 2022-05-01
</code></pre><p>Knowing the country where a transaction took place is enough information to
unambiguously find the transaction date for countries which only have one
timezone.
Since the bank that sent this data response is based in GB,
including just the country in the
API response is sufficient for many of their users.
However, the code above is incomplete for countries which have more than one
timezone (e.g., the United States).</p><h1 id=what-about-transactions-in-the-us>What about transactions in the US?</h1><p>Suppose someone makes a purchase late one evening in Denver, CO, USA.</p><pre tabindex=0><code>// txn is loaded from the API
const txn = {
  utcDateTime: &#39;2022-05-01T05:34:56.789Z&#39;, // same as 2022-04-30T23:34:56-06:00
  country: &#39;US&#39;,
  // ...
};

const zones = moment.tz.zonesForCountry(&#39;US&#39;); // (29)Â [&#39;America/Adak&#39;, ..., &#39;Pacific/Honolulu&#39;]
const zone = zones[0]; // This is not always correct. :(

moment.tz.zonesForCountry(&#39;US&#39;).map(z =&gt; {
    const m = moment(&#39;2022-05-01T05:34:56.789Z&#39;).tz(z);
    return `${m.format(&#39;YYYY-MM-DD&#39;)} in ${z} (${m.format(&#39;Z z&#39;)})`;
});

// [
//   &#39;2022-04-30 in America/Adak (-09:00 HDT)&#39;,
//   &#39;2022-04-30 in America/Anchorage (-08:00 AKDT)&#39;,
//   &#39;2022-04-30 in America/Boise (-06:00 MDT)&#39;,
//   &#39;2022-05-01 in America/Chicago (-05:00 CDT)&#39;,
//   &#39;2022-04-30 in America/Denver (-06:00 MDT)&#39;,
//   &#39;2022-05-01 in America/Detroit (-04:00 EDT)&#39;,
//   &#39;2022-05-01 in America/Indiana/Indianapolis (-04:00 EDT)&#39;,
//   &#39;2022-05-01 in America/Indiana/Knox (-05:00 CDT)&#39;,
//   &#39;2022-05-01 in America/Indiana/Marengo (-04:00 EDT)&#39;,
//   &#39;2022-05-01 in America/Indiana/Petersburg (-04:00 EDT)&#39;,
//   &#39;2022-05-01 in America/Indiana/Tell_City (-05:00 CDT)&#39;,
//   &#39;2022-05-01 in America/Indiana/Vevay (-04:00 EDT)&#39;,
//   &#39;2022-05-01 in America/Indiana/Vincennes (-04:00 EDT)&#39;,
//   &#39;2022-05-01 in America/Indiana/Winamac (-04:00 EDT)&#39;,
//   &#39;2022-04-30 in America/Juneau (-08:00 AKDT)&#39;,
//   &#39;2022-05-01 in America/Kentucky/Louisville (-04:00 EDT)&#39;,
//   &#39;2022-05-01 in America/Kentucky/Monticello (-04:00 EDT)&#39;,
//   &#39;2022-04-30 in America/Los_Angeles (-07:00 PDT)&#39;,
//   &#39;2022-05-01 in America/Menominee (-05:00 CDT)&#39;,
//   &#39;2022-04-30 in America/Metlakatla (-08:00 AKDT)&#39;,
//   &#39;2022-05-01 in America/New_York (-04:00 EDT)&#39;,
//   &#39;2022-04-30 in America/Nome (-08:00 AKDT)&#39;,
//   &#39;2022-05-01 in America/North_Dakota/Beulah (-05:00 CDT)&#39;,
//   &#39;2022-05-01 in America/North_Dakota/Center (-05:00 CDT)&#39;,
//   &#39;2022-05-01 in America/North_Dakota/New_Salem (-05:00 CDT)&#39;,
//   &#39;2022-04-30 in America/Phoenix (-07:00 MST)&#39;,
//   &#39;2022-04-30 in America/Sitka (-08:00 AKDT)&#39;,
//   &#39;2022-04-30 in America/Yakutat (-08:00 AKDT)&#39;,
//   &#39;2022-04-30 in Pacific/Honolulu (-10:00 HST)&#39;,
// ]
</code></pre><p>The list above includes both 2022-05-01 and 2022-04-30, which demonstrates that
it is not possible to always know a transaction date given the <code>utcDateTime</code> and
country of a transaction that takes place in a country with more than one
timezone.</p><p>Continuing on my goal of fixing the bug for our users in both GB and US, I
checked the bank API documentation.
Unfortunately, the API only gives the <em>country</em> in which the transaction took
place, not the <em>timezone</em> in which the transaction took place.
Unfazed, I made an informed guess and got lucky:
I manually investigated the <code>utcDateTimes</code> of transactions given by this bank&rsquo;s
API that took place in the US and concluded that this bank used the <code>'US'</code>
country code to mean the <code>'America/New_York'</code> timezone. I adjusted the code to
account for this case, published the change, and have not received bug reports
of incorrect transaction dates since.</p><p>Concluding word of advice: if you ever design an API for transactions, please
include the timezone in which the transaction took place, not just the country.</p></div></body></html>